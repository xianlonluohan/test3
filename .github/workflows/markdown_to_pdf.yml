name: Markdown to PDF Converter

on:
  push:
    branches: ["main", "master"]
    tags: ["v*"]
  pull_request:
    branches: ["main", "master"]

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    outputs:
      has_pdfs: ${{ steps.check-pdfs.outputs.has_pdfs }}
      file_count: ${{ steps.check-files.outputs.file_count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js (without cache)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # 移除 cache 设置，因为项目没有 package-lock.json
          
      - name: Install markdown-pdf globally
        run: |
          npm install -g markdown-pdf
          echo "markdown-pdf version:"
          markdown-pdf --help | head -5 || echo "markdown-pdf installed"
          
      - name: Install necessary fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-noto \
            fonts-noto-cjk \
            fonts-wqy-zenhei \
            fonts-liberation \
            fonts-dejavu \
            fonts-freefont-ttf \
            libfreetype6 \
            libfontconfig1
          
          # 刷新字体缓存
          fc-cache -fv
          
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            libasound2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgbm1 \
            libgcc1 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            lsb-release \
            wget \
            xdg-utils
          
      - name: Find all Markdown files
        id: check-files
        run: |
          # 查找所有 .md 文件，排除不需要的目录
          echo "Searching for Markdown files..."
          
          # 构建查找命令
          find . -type f -name '*.md' \
            -not -path './.git/*' \
            -not -path './node_modules/*' \
            -not -path './.github/*' \
            -not -path './pdf_output/*' > md_files.txt 2>/dev/null || true
          
          # 统计文件数量
          file_count=0
          if [ -f "md_files.txt" ]; then
            file_count=$(wc -l < md_files.txt)
          fi
          
          echo "Found $file_count Markdown files"
          
          if [ $file_count -eq 0 ]; then
            echo "No Markdown files found. Listing directory structure:"
            ls -la
            find . -type f -name "*.md" 2>/dev/null || echo "No .md files found"
          else
            echo "Markdown files found (first 10):"
            head -10 md_files.txt
          fi
          
          echo "file_count=$file_count" >> $GITHUB_OUTPUT
          
      - name: Create output directory
        run: |
          mkdir -p pdf_output
          
      - name: Create simple CSS for PDF
        run: |
          # 创建一个非常简单的CSS，避免复杂样式导致的PDF损坏
          cat > simple.css << 'EOF'
          /* 极简CSS，确保PDF能正确生成 */
          body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 12pt;
            line-height: 1.5;
            color: #000000;
            margin: 0;
            padding: 20px;
          }
          
          h1 {
            font-size: 24pt;
            margin-top: 1em;
            margin-bottom: 0.5em;
            border-bottom: 2px solid #ddd;
            padding-bottom: 0.3em;
          }
          
          h2 {
            font-size: 18pt;
            margin-top: 1em;
            margin-bottom: 0.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
          }
          
          h3 {
            font-size: 14pt;
            margin-top: 1em;
            margin-bottom: 0.5em;
          }
          
          p {
            margin: 0.5em 0;
          }
          
          code {
            font-family: "Courier New", Courier, monospace;
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10pt;
          }
          
          pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow: auto;
            font-family: "Courier New", Courier, monospace;
            font-size: 10pt;
            border: 1px solid #ddd;
          }
          
          img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
          }
          
          table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            border: 1px solid #ddd;
          }
          
          th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
          }
          
          th {
            background-color: #f2f2f2;
            font-weight: bold;
          }
          
          ul, ol {
            padding-left: 2em;
            margin: 1em 0;
          }
          
          li {
            margin: 0.3em 0;
          }
          
          a {
            color: #0066cc;
            text-decoration: none;
          }
          
          a:hover {
            text-decoration: underline;
          }
          
          blockquote {
            border-left: 4px solid #ddd;
            margin: 1em 0;
            padding-left: 1em;
            color: #666;
            font-style: italic;
          }
          
          hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2em 0;
          }
          EOF
          
          echo "Created simple.css"
          
      - name: Convert Markdown to PDF
        if: steps.check-files.outputs.file_count != '0'
        id: convert-md
        run: |
          echo "Starting PDF conversion..."
          
          total_files=0
          success_count=0
          fail_count=0
          
          if [ -f "md_files.txt" ] && [ -s "md_files.txt" ]; then
            echo "Found $(wc -l < md_files.txt) Markdown files to process"
            
            while IFS= read -r md_file; do
              total_files=$((total_files + 1))
              
              if [ ! -f "$md_file" ]; then
                echo "Warning: File not found: $md_file"
                fail_count=$((fail_count + 1))
                continue
              fi
              
              echo "--- Processing file $total_files: $md_file ---"
              
              # 获取文件基本信息
              file_dir=$(dirname "$md_file")
              file_name=$(basename "$md_file" .md)
              
              # 创建输出路径（移除开头的./）
              relative_path=$(echo "$md_file" | sed 's|^\./||')
              pdf_path="pdf_output/$(echo "$relative_path" | sed 's/\.md$/.pdf/')"
              
              # 创建输出目录
              mkdir -p "$(dirname "$pdf_path")"
              
              echo "Input: $md_file"
              echo "Output: $pdf_path"
              
              # 保存当前目录
              current_dir=$(pwd)
              
              # 进入文件所在目录以确保相对路径正确
              cd "$file_dir"
              
              # 获取当前目录下的文件名
              current_md_file=$(basename "$md_file")
              
              echo "Current directory: $(pwd)"
              echo "Markdown file: $current_md_file"
              
              # 使用简单的 markdown-pdf 命令
              echo "Running markdown-pdf..."
              
              # 尝试最简单的转换命令
              if markdown-pdf "$current_md_file" \
                --paper-format "A4" \
                --paper-border "20mm" \
                --out "../../$pdf_path" 2>&1; then
                
                echo "✓ Successfully converted: $pdf_path"
                success_count=$((success_count + 1))
                
                # 检查生成的PDF文件
                if [ -f "../../$pdf_path" ]; then
                  file_size=$(du -h "../../$pdf_path" | cut -f1)
                  echo "  File size: $file_size"
                  
                  # 验证PDF文件
                  if file "../../$pdf_path" | grep -q "PDF document"; then
                    echo "  ✓ Valid PDF document"
                  else
                    echo "  ⚠ File created but may not be a valid PDF"
                    echo "    File type: $(file "../../$pdf_path")"
                  fi
                else
                  echo "  ✗ PDF file was not created"
                  fail_count=$((fail_count + 1))
                fi
              else
                echo "✗ Failed to convert: $md_file"
                fail_count=$((fail_count + 1))
                
                # 尝试使用更简单的命令（没有选项）
                echo "  Trying with minimal options..."
                if markdown-pdf "$current_md_file" --out "../../$pdf_path" 2>&1; then
                  echo "  ✓ Minimal conversion succeeded"
                  success_count=$((success_count + 1))
                else
                  echo "  ✗ All conversion attempts failed"
                fi
              fi
              
              # 返回原始目录
              cd "$current_dir"
              
              echo ""
              
            done < md_files.txt
          else
            echo "No Markdown files to process"
          fi
          
          echo "=== Conversion Summary ==="
          echo "Total files processed: $total_files"
          echo "Successfully converted: $success_count"
          echo "Failed: $fail_count"
          
          # 保存统计信息到环境变量
          echo "SUCCESS_COUNT=$success_count" >> $GITHUB_ENV
          echo "FAIL_COUNT=$fail_count" >> $GITHUB_ENV
          
      - name: Test generated PDF files
        id: check-pdfs
        if: steps.check-files.outputs.file_count != '0'
        run: |
          echo "Checking generated PDF files..."
          
          # 检查是否有PDF文件生成
          if [ -d "pdf_output" ]; then
            pdf_count=$(find pdf_output -name "*.pdf" -type f 2>/dev/null | wc -l)
            echo "Found $pdf_count PDF files in pdf_output directory"
            
            if [ $pdf_count -gt 0 ]; then
              echo "PDF files found (first 10):"
              find pdf_output -name "*.pdf" -type f 2>/dev/null | head -10
              
              # 检查前几个PDF文件是否有效
              valid_count=0
              for pdf in $(find pdf_output -name "*.pdf" -type f 2>/dev/null | head -3); do
                echo "Checking: $pdf"
                if file "$pdf" | grep -q "PDF document"; then
                  echo "  ✓ Valid PDF: $pdf"
                  valid_count=$((valid_count + 1))
                else
                  echo "  ✗ Invalid or corrupt PDF: $pdf"
                  echo "    File type: $(file "$pdf")"
                fi
              done
              
              if [ $valid_count -gt 0 ]; then
                echo "has_pdfs=true" >> $GITHUB_OUTPUT
                echo "Valid PDF files found: $valid_count"
              else
                echo "has_pdfs=false" >> $GITHUB_OUTPUT
                echo "No valid PDF files found"
              fi
            else
              echo "No PDF files found in pdf_output directory"
              echo "has_pdfs=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "pdf_output directory does not exist"
            echo "has_pdfs=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create ZIP archive of PDFs
        if: steps.check-pdfs.outputs.has_pdfs == 'true'
        id: create-zip
        run: |
          echo "Creating ZIP archive..."
          
          # 生成版本名称
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version="${GITHUB_REF#refs/tags/}"
          else
            version="$(date +%Y%m%d)-$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
          fi
          
          zip_name="documentation-pdf-${version}.zip"
          
          # 检查是否有PDF文件
          pdf_files_count=$(find pdf_output -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          if [ $pdf_files_count -gt 0 ]; then
            echo "Found $pdf_files_count PDF files to compress"
            
            # 压缩PDF目录
            cd pdf_output
            zip -r "../${zip_name}" . -i "*.pdf"
            cd ..
            
            # 检查ZIP文件
            if [ -f "$zip_name" ]; then
              zip_size=$(du -h "$zip_name" | cut -f1)
              echo "✓ Created ZIP: $zip_name ($zip_size)"
              echo "Files in ZIP:"
              unzip -l "$zip_name" | tail -5
            else
              echo "✗ Failed to create ZIP file"
            fi
          else
            echo "No PDF files found to compress"
          fi
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-pdfs
          path: |
            pdf_output/
            documentation-pdf-*.zip
          if-no-files-found: warn
          retention-days: 7
          
      - name: Display results
        run: |
          echo "=== Markdown to PDF Conversion Results ==="
          echo ""
          echo "Markdown files found: ${{ steps.check-files.outputs.file_count || 0 }}"
          echo "Successfully converted: ${{ env.SUCCESS_COUNT || 0 }}"
          echo "Failed: ${{ env.FAIL_COUNT || 0 }}"
          echo ""
          
          if [ -d "pdf_output" ]; then
            echo "Generated PDF files:"
            find pdf_output -name "*.pdf" -type f 2>/dev/null | sort | head -20
            echo ""
            echo "Total PDF files generated: $(find pdf_output -name "*.pdf" -type f 2>/dev/null | wc -l)"
          fi
          
  release:
    needs: convert-md-to-pdf
    if: startsWith(github.ref, 'refs/tags/') && needs.convert-md-to-pdf.outputs.has_pdfs == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-pdfs
          
      - name: Prepare release files
        run: |
          echo "Preparing release files..."
          
          # 检查文件
          ls -la
          if [ -d "pdf_output" ]; then
            echo "PDF files:"
            find pdf_output -name "*.pdf" -type f | head -10
          fi
          
          # 查找ZIP文件
          zip_file=$(find . -name "documentation-pdf-*.zip" -type f | head -1)
          if [ -n "$zip_file" ]; then
            echo "Found ZIP file: $zip_file"
          fi
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Documentation PDFs - ${{ github.ref_name }}"
          body: |
            # Documentation PDFs
            
            This release contains PDF versions of all Markdown documentation found in the repository.
            
            ## Included Files
            
            All Markdown files have been converted to PDF format while preserving the original directory structure.
            
            ## How to Use
            
            1. Download the ZIP file to get all PDF documents at once
            2. Or download individual PDF files from the assets list
            
            ## Generation Details
            
            - Generated: $(date +'%Y-%m-%d %H:%M:%S')
            - Source: ${{ github.repository }}@${{ github.sha }}
            - Workflow: ${{ github.workflow }}
            
            ## File Structure
            
            The PDF files maintain the same directory structure as the original Markdown files.
            
            ---
            
            *Automatically generated by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            documentation-pdf-*.zip
            pdf_output/**/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}