name: "Markdown to PDF Converter - Simple and Reliable"

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
      
      - name: "Install dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-latex-recommended \
            texlive-lang-chinese \
            fonts-noto-cjk \
            fonts-wqy-zenhei \
            lmodern
      
      - name: "Create simple LaTeX template"
        run: |
          cat > template.tex << 'EOF'
          \documentclass[12pt]{article}
          \usepackage{xeCJK}
          \usepackage[UTF8]{ctex}
          \setCJKmainfont{Noto Serif CJK SC}
          \setCJKsansfont{Noto Sans CJK SC}
          \setCJKmonofont{Noto Sans Mono CJK SC}
          
          \usepackage[a4paper, margin=1in]{geometry}
          \usepackage{hyperref}
          \hypersetup{
            colorlinks=true,
            linkcolor=blue,
            urlcolor=blue,
          }
          
          % 图片支持
          \usepackage{graphicx}
          \usepackage{float}
          \usepackage{caption}
          
          % 表格支持 - 使用最简化的设置
          \usepackage{booktabs}
          \usepackage{longtable}
          \usepackage{array}
          
          % 设置表格格式
          \renewcommand{\arraystretch}{1.3}
          \setlength{\tabcolsep}{6pt}
          
          % 防止表格过宽
          \usepackage{tabularx}
          
          % 代码高亮
          \usepackage{listings}
          \usepackage{xcolor}
          \definecolor{codebg}{rgb}{0.95,0.95,0.95}
          \lstset{
            basicstyle=\ttfamily\small,
            backgroundcolor=\color{codebg},
            frame=single,
            breaklines=true,
          }
          
          % 水印
          \usepackage{draftwatermark}
          \SetWatermarkText{emakefun}
          \SetWatermarkScale{3}
          \SetWatermarkColor[gray]{0.9}
          \SetWatermarkAngle{45}
          
          % 页眉页脚
          \usepackage{fancyhdr}
          \pagestyle{fancy}
          \fancyhf{}
          \fancyfoot[C]{\thepage}
          \renewcommand{\headrulewidth}{0pt}
          
          \begin{document}
          \$if(toc)$
          \tableofcontents
          \newpage
          \$endif$
          
          \$body$
          
          \end{document}
          EOF
      
      - name: "Test conversion on one file"
        run: |
          # 先测试一个文件
          TEST_FILE="AI小智和超声波结合/01_超声波模块介绍.md"
          
          if [ -f "$TEST_FILE" ]; then
            echo "========================================"
            echo "测试转换: $TEST_FILE"
            echo "========================================"
            
            # 显示文件内容预览
            echo "文件预览（前50行）："
            head -50 "$TEST_FILE"
            echo "..."
            
            # 创建输出目录
            mkdir -p pdf_output/AI小智和超声波结合
            
            # 转换PDF
            echo "开始转换..."
            
            pandoc "$TEST_FILE" \
              --template=template.tex \
              -o "pdf_output/AI小智和超声波结合/01_超声波模块介绍.pdf" \
              --pdf-engine=xelatex \
              -V geometry:margin=1in \
              -V geometry:a4paper \
              --toc \
              --toc-depth=2 \
              -N \
              2>&1 | tee conversion.log
            
            if [ $? -eq 0 ]; then
              echo "✓ 转换完成"
              
              # 检查文件
              if [ -f "pdf_output/AI小智和超声波结合/01_超声波模块介绍.pdf" ]; then
                echo "文件大小: $(du -h pdf_output/AI小智和超声波结合/01_超声波模块介绍.pdf | cut -f1)"
                echo "页数估计: $(pdfinfo pdf_output/AI小智和超声波结合/01_超声波模块介绍.pdf 2>/dev/null | grep Pages | awk '{print $2}' || echo '未知')"
              fi
            else
              echo "✗ 转换失败"
              cat conversion.log
            fi
            
            rm -f conversion.log
          else
            echo "测试文件不存在"
          fi
      
      - name: "Convert all Markdown files"
        run: |
          echo "========================================"
          echo "批量转换所有Markdown文件"
          echo "========================================"
          
          # 查找所有.md文件
          MD_FILES=$(find . -name "*.md" -not -path "./.*" -not -path "./pdf_output/*" -not -path "*/node_modules/*")
          
          total_files=$(echo "$MD_FILES" | wc -l)
          echo "找到 $total_files 个Markdown文件"
          
          success_count=0
          fail_count=0
          
          for md_file in $MD_FILES; do
            echo "处理: $md_file"
            
            # 创建输出目录
            dir_name=$(dirname "$md_file")
            base_name=$(basename "$md_file" .md)
            
            mkdir -p "pdf_output/$dir_name"
            
            # 转换
            if pandoc "$md_file" \
              --template=template.tex \
              -o "pdf_output/$dir_name/$base_name.pdf" \
              --pdf-engine=xelatex \
              -V geometry:margin=1in \
              -V geometry:a4paper \
              --toc \
              --toc-depth=2 \
              -N \
              >/dev/null 2>&1; then
              
              if [ -f "pdf_output/$dir_name/$base_name.pdf" ] && [ -s "pdf_output/$dir_name/$base_name.pdf" ]; then
                echo "  ✓ 成功"
                success_count=$((success_count + 1))
              else
                echo "  ✗ 文件为空"
                fail_count=$((fail_count + 1))
              fi
            else
              echo "  ✗ 转换失败"
              fail_count=$((fail_count + 1))
            fi
          done
          
          echo "========================================"
          echo "完成: $success_count 成功, $fail_count 失败"
          echo "========================================"
      
      - name: "Copy resource files"
        run: |
          echo "复制resource文件..."
          
          # 查找所有有PDF文件的目录
          find pdf_output -name "*.pdf" | while read pdf_file; do
            pdf_dir=$(dirname "$pdf_file")
            source_dir=${pdf_dir#pdf_output/}
            
            # 复制resource目录
            if [ -d "$source_dir/resource" ]; then
              echo "复制 $source_dir/resource 到 $pdf_dir/"
              cp -r "$source_dir/resource" "$pdf_dir/" 2>/dev/null || true
            fi
          done
      
      - name: "Upload PDF artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents
          path: pdf_output/
          retention-days: 7