name: Convert Markdown to PDF and Release

on:
  push:
    tags:
      - 'v*'  # å½“åˆ›å»ºä»¥vå¼€å¤´çš„tagæ—¶è§¦å‘
    branches:
      - main
      - develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    outputs:
      pdf_files: ${{ steps.find-pdfs.outputs.pdf_files }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # ä¿®å¤çš„Node.jsè®¾ç½®æ­¥éª¤
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
      # ç§»é™¤äº† cache: 'npm' é¿å…æ‰¾ä¸åˆ°lockæ–‡ä»¶çš„é”™è¯¯
    
    - name: Install dependencies
      run: |
        # åˆ›å»ºä¸´æ—¶package.jsonä»¥æ”¯æŒç¼“å­˜ï¼ˆå¯é€‰ï¼‰
        if [ ! -f "package.json" ]; then
          echo '{"name": "markdown-pdf-converter", "version": "1.0.0"}' > package.json
        fi
        
        # å®‰è£…markdown-pdf
        npm install -g markdown-pdf
        
        # å®‰è£…å…¶ä»–å·¥å…·
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra
        
        # å¦‚æœéœ€è¦ä¸­æ–‡æ”¯æŒ
        sudo apt-get install -y fonts-noto-cjk
    
    - name: Create package-lock for caching (å¯é€‰)
      run: |
        # å¦‚æœå¸Œæœ›æœ‰ç¼“å­˜ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªç©ºçš„lockæ–‡ä»¶
        if [ ! -f "package-lock.json" ]; then
          npm init -y
          npm install --package-lock-only --no-save markdown-pdf
        fi
    
    - name: Find all Markdown files
      id: find-md-files
      run: |
        # æŸ¥æ‰¾æ‰€æœ‰ç›®å½•ä¸­çš„markdownæ–‡ä»¶
        find . -name "*.md" ! -path "./.git/*" ! -path "./node_modules/*" > markdown_files.txt
        echo "Found markdown files:"
        cat markdown_files.txt
        
        # è®¡ç®—æ–‡ä»¶æ•°é‡
        count=$(wc -l < markdown_files.txt)
        echo "count=$count" >> $GITHUB_OUTPUT
        echo "md_files=$(cat markdown_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
    
    - name: Create output directory
      run: |
        mkdir -p pdf_output
    
    - name: Convert Markdown to PDF
      if: steps.find-md-files.outputs.count != '0'
      run: |
        echo "Converting ${{ steps.find-md-files.outputs.count }} markdown files..."
        
        # ä½¿ç”¨whileå¾ªç¯å¤„ç†æ¯ä¸ªæ–‡ä»¶
        while IFS= read -r md_file; do
          if [ -f "$md_file" ]; then
            echo "Processing: $md_file"
            
            # è·å–ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å
            filename=$(basename "$md_file" .md)
            # è·å–æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç›¸å¯¹è·¯å¾„
            dir_path=$(dirname "$md_file")
            
            # åœ¨è¾“å‡ºç›®å½•ä¸­åˆ›å»ºç›¸åŒçš„ç›®å½•ç»“æ„
            mkdir -p "pdf_output/$dir_path"
            
            # ä½¿ç”¨markdown-pdfè½¬æ¢
            echo "Converting $md_file to pdf_output/$dir_path/$filename.pdf"
            
            # å°è¯•ä½¿ç”¨markdown-pdf
            if markdown-pdf "$md_file" -o "pdf_output/$dir_path/$filename.pdf" \
               --paper-format "A4" \
               --paper-orientation "portrait" \
               --paper-border "1cm"; then
              echo "âœ“ Success: $filename.pdf"
            else
              echo "markdown-pdf failed, trying pandoc..."
              # å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨pandoc
              pandoc "$md_file" \
                --pdf-engine=xelatex \
                -V geometry:margin=1in \
                -V mainfont="DejaVu Serif" \
                -o "pdf_output/$dir_path/$filename.pdf"
            fi
          fi
        done < markdown_files.txt
    
    - name: Handle images and resources
      run: |
        # å¤åˆ¶å›¾ç‰‡å’Œèµ„æºåˆ°è¾“å‡ºç›®å½•ï¼Œä¿æŒç›¸å¯¹è·¯å¾„
        echo "Copying images and resources..."
        
        # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„èµ„æºç›®å½•
        find . -type d \( \
          -name "picture" -o \
          -name "pictures" -o \
          -name "image" -o \
          -name "images" -o \
          -name "resource" -o \
          -name "resources" -o \
          -name "assets" \
        \) ! -path "./.git/*" ! -path "./pdf_output/*" | while read -r dir; do
          if [ -d "$dir" ]; then
            # è®¡ç®—ç›¸å¯¹è·¯å¾„
            rel_path=${dir#./}
            target_dir="pdf_output/$rel_path"
            
            echo "Copying $dir to $target_dir"
            mkdir -p "$target_dir"
            
            # å¤åˆ¶ç›®å½•å†…å®¹ï¼Œå¿½ç•¥é”™è¯¯
            cp -r "$dir"/* "$target_dir/" 2>/dev/null || true
          fi
        done
        
        # å¤åˆ¶å•ç‹¬çš„å›¾ç‰‡æ–‡ä»¶
        find . -type f \( \
          -name "*.png" -o \
          -name "*.jpg" -o \
          -name "*.jpeg" -o \
          -name "*.gif" -o \
          -name "*.svg" \
        \) ! -path "./.git/*" ! -path "./pdf_output/*" | while read -r img; do
          # è®¡ç®—ç›¸å¯¹è·¯å¾„
          rel_path=${img#./}
          target_dir="pdf_output/$(dirname "$rel_path")"
          
          mkdir -p "$target_dir"
          cp "$img" "$target_dir/" 2>/dev/null || true
        done
    
    - name: Create PDF index
      run: |
        # åˆ›å»ºç´¢å¼•æ–‡ä»¶
        echo "# ğŸ“„ PDF Documentation Index" > pdf_output/README.md
        echo "" >> pdf_output/README.md
        echo "## ğŸ“… Generation Info" >> pdf_output/README.md
        echo "- **Generated on**: $(date '+%Y-%m-%d %H:%M:%S')" >> pdf_output/README.md
        echo "- **Commit**: ${{ github.sha }}" >> pdf_output/README.md
        echo "- **Repository**: ${{ github.repository }}" >> pdf_output/README.md
        echo "" >> pdf_output/README.md
        
        # åˆ—å‡ºæ‰€æœ‰PDFæ–‡ä»¶
        echo "## ğŸ“š PDF Files" >> pdf_output/README.md
        echo "" >> pdf_output/README.md
        
        if [ "$(find pdf_output -name "*.pdf" | wc -l)" -gt 0 ]; then
          find pdf_output -name "*.pdf" | sort | while read -r pdf; do
            rel_path=${pdf#pdf_output/}
            file_size=$(stat -c%s "$pdf" 2>/dev/null || stat -f%z "$pdf")
            file_size_mb=$(echo "scale=2; $file_size / 1024 / 1024" | bc)
            echo "- [${rel_path}](${rel_path}) (${file_size_mb} MB)" >> pdf_output/README.md
          done
        else
          echo "No PDF files were generated." >> pdf_output/README.md
        fi
        
        echo "" >> pdf_output/README.md
        
        # åˆ—å‡ºèµ„æºç›®å½•
        echo "## ğŸ–¼ï¸ Resources" >> pdf_output/README.md
        echo "" >> pdf_output/README.md
        
        resource_dirs=$(find pdf_output -type d \( \
          -name "*picture*" -o \
          -name "*image*" -o \
          -name "*resource*" -o \
          -name "*asset*" \
        \) 2>/dev/null | sort)
        
        if [ -n "$resource_dirs" ]; then
          echo "$resource_dirs" | while read -r dir; do
            rel_dir=${dir#pdf_output/}
            echo "- **${rel_dir}/**" >> pdf_output/README.md
            
            # åˆ—å‡ºç›®å½•ä¸­çš„æ–‡ä»¶
            find "$dir" -maxdepth 1 -type f | while read -r file; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "  - ${filename}" >> pdf_output/README.md
              fi
            done
          done
        else
          echo "No resource directories found." >> pdf_output/README.md
        fi
    
    - name: Package PDFs
      run: |
        # ç¡®å®šç‰ˆæœ¬å·
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="latest-$(date +%Y%m%d-%H%M%S)"
        fi
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd pdf_output
        zip -r "../documentation-${VERSION}.zip" .
        cd ..
        
        echo "Created: documentation-${VERSION}.zip"
        echo "PDF_ZIP=documentation-${VERSION}.zip" >> $GITHUB_ENV
        
        # è®¡ç®—æ–‡ä»¶å¤§å°
        if [ -f "documentation-${VERSION}.zip" ]; then
          file_size=$(stat -c%s "documentation-${VERSION}.zip")
          file_size_mb=$(echo "scale=2; $file_size / 1024 / 1024" | bc)
          echo "ZIP_SIZE_MB=${file_size_mb}" >> $GITHUB_ENV
        fi
    
    - name: Find generated PDFs
      id: find-pdfs
      run: |
        # ç»Ÿè®¡ç”Ÿæˆçš„PDF
        pdf_count=$(find pdf_output -name "*.pdf" 2>/dev/null | wc -l)
        echo "Generated $pdf_count PDF files"
        echo "pdf_count=$pdf_count" >> $GITHUB_OUTPUT
        
        # åˆ—å‡ºæ‰€æœ‰PDFæ–‡ä»¶
        if [ $pdf_count -gt 0 ]; then
          find pdf_output -name "*.pdf" | sort > pdf_list.txt
          echo "PDF files:"
          cat pdf_list.txt
          
          # è½¬æ¢ä¸ºJSONæ•°ç»„
          pdf_files_json=$(jq -R -n '[inputs]' < pdf_list.txt 2>/dev/null || echo '[]')
          echo "pdf_files=$pdf_files_json" >> $GITHUB_OUTPUT
        else
          echo "pdf_files=[]" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf-documents
        path: |
          pdf_output/
          documentation-*.zip
        retention-days: 30

  create-release:
    needs: convert-md-to-pdf
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download PDF artifacts
      uses: actions/download-artifact@v4
      with:
        name: pdf-documents
        path: ./pdf-artifacts
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Documentation v${{ github.ref_name }}
        body: |
          # ğŸ“„ PDF Documentation Release
          
          This release contains PDF versions of all Markdown documentation.
          
          ## ğŸ“Š Summary
          - **Generated on**: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
          - **Commit**: ${{ github.sha }}
          - **Total PDFs**: ${{ needs.convert-md-to-pdf.outputs.pdf_count }}
          
          ## ğŸ“¦ Contents
          1. **Complete Archive**: Contains all PDFs and resources
          2. **Individual PDFs**: Available as separate attachments
          3. **Resource Files**: Images and other assets
          
          ## ğŸ”§ How to Use
          1. Download `documentation-${{ github.ref_name }}.zip` for offline use
          2. Extract the ZIP archive
          3. Open PDF files in any PDF viewer
          
          ## ğŸ“ File Structure
          The archive maintains the original directory structure from the repository.
          
          ---
          
          *Generated automatically by GitHub Actions*
        draft: false
        prerelease: false
        files: |
          pdf-artifacts/documentation-${{ github.ref_name }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}