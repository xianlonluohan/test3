name: Markdown to PDF Converter

on:
  push:
    branches: ["main", "master"]
    tags: ["v*"]
  pull_request:
    branches: ["main", "master"]

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    outputs:
      has_pdfs: ${{ steps.check-pdfs.outputs.has_pdfs }}
      file_count: ${{ steps.check-files.outputs.file_count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # 移除 cache 参数，避免 package-lock.json 错误
          
      - name: Install markdown-pdf globally
        run: |
          # 清除 npm 缓存
          npm cache clean --force
          # 安装 markdown-pdf
          npm install -g markdown-pdf
          echo "markdown-pdf version:"
          markdown-pdf --help | head -2 || echo "markdown-pdf installed"
          
      - name: Install necessary fonts for Chinese support
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-noto \
            fonts-noto-cjk \
            fonts-wqy-zenhei \
            fonts-liberation \
            fonts-dejavu \
            fonts-freefont-ttf \
            libfreetype6 \
            libfontconfig1
          
          # 刷新字体缓存
          fc-cache -fv
          
      - name: Install minimal dependencies for PDF generation
        run: |
          # 只安装必要的包，避免包名问题
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            libc6 \
            libcairo2 \
            libexpat1 \
            libfontconfig1 \
            libfreetype6 \
            libgcc-s1 \
            libglib2.0-0 \
            libpango-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libxcb1 \
            libxext6 \
            libxrender1 \
            wget
          
      - name: Find all Markdown files
        id: check-files
        run: |
          echo "=== Searching for Markdown files ==="
          
          # 查找所有 .md 文件，排除不需要的目录
          find . -type f -name '*.md' \
            -not -path './.git/*' \
            -not -path './node_modules/*' \
            -not -path './.github/*' \
            -not -path './pdf_output/*' > md_files.txt 2>/dev/null || true
          
          # 统计文件数量
          file_count=0
          if [ -f "md_files.txt" ] && [ -s "md_files.txt" ]; then
            file_count=$(wc -l < md_files.txt)
          fi
          
          echo "Found $file_count Markdown files"
          
          if [ $file_count -eq 0 ]; then
            echo "No Markdown files found. Listing all files:"
            find . -type f -name "*.md" 2>/dev/null || echo "No .md files found"
          else
            echo "First 5 Markdown files:"
            head -5 md_files.txt
          fi
          
          echo "file_count=$file_count" >> $GITHUB_OUTPUT
          
      - name: Create output directory
        run: |
          mkdir -p pdf_output
          
      - name: Convert Markdown to PDF (minimal approach)
        if: steps.check-files.outputs.file_count != '0'
        id: convert-md
        run: |
          echo "=== Starting PDF conversion ==="
          
          total_files=0
          success_count=0
          fail_count=0
          
          if [ -f "md_files.txt" ] && [ -s "md_files.txt" ]; then
            echo "Found $(wc -l < md_files.txt) Markdown files to process"
            
            while IFS= read -r md_file; do
              total_files=$((total_files + 1))
              
              if [ ! -f "$md_file" ]; then
                echo "Warning: File not found: $md_file"
                fail_count=$((fail_count + 1))
                continue
              fi
              
              echo "--- Processing file $total_files: $md_file ---"
              
              # 获取文件基本信息
              file_dir=$(dirname "$md_file")
              file_name=$(basename "$md_file" .md)
              
              # 创建输出路径（移除开头的./）
              relative_path=$(echo "$md_file" | sed 's|^\./||')
              pdf_path="pdf_output/$(echo "$relative_path" | sed 's/\.md$/.pdf/')"
              
              # 创建输出目录
              mkdir -p "$(dirname "$pdf_path")"
              
              echo "Input: $md_file"
              echo "Output: $pdf_path"
              
              # 保存当前目录
              current_dir=$(pwd)
              
              # 进入文件所在目录以确保相对路径正确
              cd "$file_dir"
              
              # 获取当前目录下的文件名
              current_md_file=$(basename "$md_file")
              
              echo "Running markdown-pdf..."
              
              # 使用最简单的 markdown-pdf 命令
              if markdown-pdf "$current_md_file" --out "../../$pdf_path"; then
                echo "✓ Successfully converted: $pdf_path"
                success_count=$((success_count + 1))
                
                # 检查生成的PDF文件
                if [ -f "../../$pdf_path" ]; then
                  file_size=$(du -h "../../$pdf_path" | cut -f1)
                  echo "  File size: $file_size"
                else
                  echo "  ✗ PDF file was not created"
                  fail_count=$((fail_count + 1))
                fi
              else
                echo "✗ Failed to convert: $md_file"
                fail_count=$((fail_count + 1))
              fi
              
              # 返回原始目录
              cd "$current_dir"
              
              echo ""
              
            done < ../md_files.txt
          else
            echo "No Markdown files to process"
          fi
          
          echo "=== Conversion Summary ==="
          echo "Total files processed: $total_files"
          echo "Successfully converted: $success_count"
          echo "Failed: $fail_count"
          
          # 保存统计信息到环境变量
          echo "SUCCESS_COUNT=$success_count" >> $GITHUB_ENV
          echo "FAIL_COUNT=$fail_count" >> $GITHUB_ENV
          
      - name: Test generated PDF files
        id: check-pdfs
        if: steps.check-files.outputs.file_count != '0'
        run: |
          echo "=== Checking generated PDF files ==="
          
          # 检查是否有PDF文件生成
          if [ -d "pdf_output" ]; then
            pdf_count=$(find pdf_output -name "*.pdf" -type f 2>/dev/null | wc -l)
            echo "Found $pdf_count PDF files"
            
            if [ $pdf_count -gt 0 ]; then
              echo "First 3 PDF files:"
              find pdf_output -name "*.pdf" -type f 2>/dev/null | head -3
              
              # 检查PDF文件是否有效
              valid_count=0
              for pdf in $(find pdf_output -name "*.pdf" -type f 2>/dev/null | head -3); do
                echo "Checking: $pdf"
                if file "$pdf" | grep -q "PDF document"; then
                  echo "  ✓ Valid PDF document"
                  valid_count=$((valid_count + 1))
                else
                  echo "  ✗ Invalid or corrupt PDF"
                  echo "    File type: $(file "$pdf")"
                fi
              done
              
              if [ $valid_count -gt 0 ]; then
                echo "has_pdfs=true" >> $GITHUB_OUTPUT
                echo "Valid PDF files found: $valid_count"
              else
                echo "has_pdfs=false" >> $GITHUB_OUTPUT
                echo "No valid PDF files found"
              fi
            else
              echo "No PDF files found in pdf_output directory"
              echo "has_pdfs=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "pdf_output directory does not exist"
            echo "has_pdfs=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create ZIP archive of PDFs
        if: steps.check-pdfs.outputs.has_pdfs == 'true'
        id: create-zip
        run: |
          echo "=== Creating ZIP archive ==="
          
          # 生成版本名称
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version="${GITHUB_REF#refs/tags/}"
          else
            version="$(date +%Y%m%d)-$(git rev-parse --short HEAD 2>/dev/null || echo 'snapshot')"
          fi
          
          zip_name="documentation-pdf-${version}.zip"
          
          # 检查是否有PDF文件
          pdf_files_count=$(find pdf_output -name "*.pdf" -type f 2>/dev/null | wc -l)
          
          if [ $pdf_files_count -gt 0 ]; then
            echo "Found $pdf_files_count PDF files to compress"
            
            # 压缩PDF目录
            cd pdf_output
            zip -r "../${zip_name}" . -i "*.pdf"
            cd ..
            
            # 检查ZIP文件
            if [ -f "$zip_name" ]; then
              zip_size=$(du -h "$zip_name" | cut -f1)
              echo "✓ Created ZIP: $zip_name ($zip_size)"
            else
              echo "✗ Failed to create ZIP file"
            fi
          else
            echo "No PDF files found to compress"
          fi
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-pdfs
          path: |
            pdf_output/
            documentation-pdf-*.zip
          if-no-files-found: warn
          retention-days: 7
          
      - name: Display results
        run: |
          echo "=== Conversion Results ==="
          echo ""
          echo "Markdown files found: ${{ steps.check-files.outputs.file_count || 0 }}"
          echo "Successfully converted: ${{ env.SUCCESS_COUNT || 0 }}"
          echo "Failed: ${{ env.FAIL_COUNT || 0 }}"
          echo ""
          
          if [ -d "pdf_output" ]; then
            echo "Generated PDF files (first 10):"
            find pdf_output -name "*.pdf" -type f 2>/dev/null | sort | head -10
          fi
          
  release:
    needs: convert-md-to-pdf
    if: startsWith(github.ref, 'refs/tags/') && needs.convert-md-to-pdf.outputs.has_pdfs == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-pdfs
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Documentation PDFs - ${{ github.ref_name }}"
          body: |
            # Documentation PDFs
            
            This release contains PDF versions of all Markdown documentation found in the repository.
            
            ## Included Files
            
            All Markdown files have been converted to PDF format while preserving the original directory structure.
            
            ## How to Use
            
            1. Download the ZIP file to get all PDF documents at once
            2. Or download individual PDF files from the assets list
            
            ## Generation Details
            
            - Generated: $(date +'%Y-%m-%d %H:%M:%S')
            - Source: ${{ github.repository }}@${{ github.sha }}
            - Workflow: ${{ github.workflow }}
            
            ---
            
            *Automatically generated by GitHub Actions*
          draft: false
          preredule: false
          files: |
            documentation-pdf-*.zip
            pdf_output/**/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}