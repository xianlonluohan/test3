name: Convert Markdown to PDF and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup environment
      run: |
        # å®‰è£…å®Œæ•´çš„TeX Liveä»¥æ”¯æŒxelatex
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-latex-recommended \
          texlive-xetex \
          texlive-fonts-recommended \
          texlive-fonts-extra \
          texlive-lang-chinese \
          fonts-noto-cjk \
          fonts-wqy-zenhei \
          fonts-wqy-microhei \
          lmodern
        
        # å®‰è£…pandoc
        sudo apt-get install -y pandoc
        
        # å®‰è£…Node.jså’Œæ›¿ä»£çš„Markdownè½¬PDFå·¥å…·
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        
        # å®‰è£…md-to-pdfï¼ˆæ¯”markdown-pdfæ›´ç°ä»£çš„å·¥å…·ï¼‰
        sudo npm install -g md-to-pdf
        
        # éªŒè¯å®‰è£…
        pandoc --version
        xelatex --version
        node --version
    
    - name: Find all Markdown files
      id: find-md-files
      run: |
        # æŸ¥æ‰¾æ‰€æœ‰ç›®å½•ä¸­çš„markdownæ–‡ä»¶ï¼Œæ’é™¤.gitç›®å½•
        find . -name "*.md" ! -path "./.git/*" ! -path "./node_modules/*" > markdown_files.txt
        count=$(wc -l < markdown_files.txt)
        echo "Found $count markdown files"
        echo "count=$count" >> $GITHUB_OUTPUT
        echo "md_files=$(cat markdown_files.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> $GITHUB_OUTPUT
    
    - name: Create output directory
      run: |
        mkdir -p pdf_output
    
    - name: Copy resources for pandoc
      run: |
        # ä¸ºpandocå‡†å¤‡èµ„æºç›®å½•ç»“æ„
        # å¤åˆ¶æ‰€æœ‰å›¾ç‰‡å’Œèµ„æºåˆ°ä¸´æ—¶ç›®å½•ï¼Œä¿æŒç›¸å¯¹è·¯å¾„
        find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" \) \
          ! -path "./.git/*" ! -path "./pdf_output/*" | while read -r file; do
          rel_path="${file#./}"
          target_dir="resources/$(dirname "$rel_path")"
          mkdir -p "$target_dir"
          cp "$file" "$target_dir/" 2>/dev/null || true
        done
        
        # å¤åˆ¶èµ„æºæ–‡ä»¶å¤¹
        find . -type d \( -name "picture" -o -name "resource" \) ! -path "./.git/*" | while read -r dir; do
          rel_path="${dir#./}"
          target_dir="resources/$rel_path"
          mkdir -p "$target_dir"
          cp -r "$dir"/* "$target_dir/" 2>/dev/null || true
        done
    
    - name: Convert Markdown to PDF using Pandoc
      if: steps.find-md-files.outputs.count != '0'
      run: |
        echo "Converting ${{ steps.find-md-files.outputs.count }} markdown files using Pandoc..."
        
        # è¯»å–æ–‡ä»¶åˆ—è¡¨
        mapfile -t files < markdown_files.txt
        
        for md_file in "${files[@]}"; do
          if [ -f "$md_file" ]; then
            echo "Processing: $md_file"
            
            # è·å–æ–‡ä»¶åå’Œè·¯å¾„
            filename=$(basename "$md_file" .md)
            dir_path=$(dirname "$md_file")
            
            # åœ¨è¾“å‡ºç›®å½•ä¸­åˆ›å»ºç›¸åŒçš„ç›®å½•ç»“æ„
            mkdir -p "pdf_output/$dir_path"
            
            # æ„å»ºè¾“å‡ºè·¯å¾„
            output_pdf="pdf_output/$dir_path/$filename.pdf"
            
            # è®¡ç®—èµ„æºè·¯å¾„ï¼ˆç›¸å¯¹äºMarkdownæ–‡ä»¶çš„è·¯å¾„ï¼‰
            md_dir=$(dirname "$md_file")
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå¤„ç†
            temp_dir=$(mktemp -d)
            
            # å¤åˆ¶Markdownæ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
            cp "$md_file" "$temp_dir/"
            
            # å¤åˆ¶ç›¸å…³èµ„æºåˆ°ä¸´æ—¶ç›®å½•
            if [ -d "resources/$md_dir" ]; then
              mkdir -p "$temp_dir/$(basename "$md_dir")"
              cp -r "resources/$md_dir"/* "$temp_dir/$(basename "$md_dir")/" 2>/dev/null || true
            fi
            
            # è¿›å…¥ä¸´æ—¶ç›®å½•å¤„ç†
            cd "$temp_dir"
            temp_md=$(basename "$md_file")
            
            # æ–¹æ³•1ï¼šä½¿ç”¨Pandoc + XeLaTeXï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
            echo "Converting with Pandoc + XeLaTeX..."
            
            # åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿æˆ–ä½¿ç”¨é»˜è®¤
            pandoc "$temp_md" \
              --pdf-engine=xelatex \
              -V mainfont="Noto Serif CJK SC" \
              -V sansfont="Noto Sans CJK SC" \
              -V monofont="Noto Sans Mono CJK SC" \
              -V geometry:margin=1in \
              -V colorlinks=true \
              -V linkcolor=blue \
              -V urlcolor=blue \
              -V toccolor=blue \
              -V papersize=a4 \
              -V documentclass=article \
              --toc \
              --toc-depth=3 \
              -o "$output_pdf" \
              --resource-path="$temp_dir:$(dirname "$md_file")" \
              2>&1 | tee conversion.log || {
                echo "Pandoc conversion failed for $md_file"
                cat conversion.log
                
                # æ–¹æ³•2ï¼šå›é€€æ–¹æ¡ˆ - è½¬æ¢ä¸ºHTMLå†è½¬PDF
                echo "Trying HTML conversion as fallback..."
                
                # å…ˆè½¬æ¢ä¸ºHTML
                pandoc "$temp_md" \
                  -t html5 \
                  --self-contained \
                  --css=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css \
                  -o "$temp_md.html"
                
                # ä½¿ç”¨wkhtmltopdfè½¬æ¢ä¸ºPDFï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if command -v wkhtmltopdf &> /dev/null; then
                  wkhtmltopdf "$temp_md.html" "$output_pdf" || \
                  echo "wkhtmltopdf also failed for $md_file"
                else
                  # å®‰è£…wkhtmltopdf
                  sudo apt-get install -y wkhtmltopdf
                  wkhtmltopdf "$temp_md.html" "$output_pdf" || \
                  echo "Failed to install or use wkhtmltopdf"
                fi
              }
            
            cd - > /dev/null
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$temp_dir"
            
            if [ -f "$output_pdf" ]; then
              echo "âœ“ Successfully created: $output_pdf"
              pdf_size=$(stat -c%s "$output_pdf" 2>/dev/null || stat -f%z "$output_pdf")
              pdf_size_mb=$(echo "scale=2; $pdf_size / 1024 / 1024" | bc)
              echo "  File size: ${pdf_size_mb} MB"
            else
              echo "âœ— Failed to create PDF for: $md_file"
            fi
          fi
        done
    
    - name: Alternative conversion with md-to-pdf (å¦‚æœPandocå¤±è´¥)
      if: failure()
      run: |
        echo "Trying alternative conversion with md-to-pdf..."
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶
        cat > pdf-config.json << 'EOF'
        {
          "stylesheet": [
            "https://cdn.jsdelivr.net/npm/water.css@2/out/water.css",
            "body { font-family: 'Noto Serif CJK SC', serif; }"
          ],
          "pdf_options": {
            "format": "A4",
            "margin": "1cm",
            "printBackground": true
          },
          "stylesheet_encoding": "utf-8"
        }
        EOF
        
        # è½¬æ¢å‰å‡ ä¸ªæ–‡ä»¶ä½œä¸ºæµ‹è¯•
        head -10 markdown_files.txt | while read -r md_file; do
          if [ -f "$md_file" ]; then
            filename=$(basename "$md_file" .md)
            dir_path=$(dirname "$md_file")
            mkdir -p "pdf_output/$dir_path"
            
            echo "Converting with md-to-pdf: $md_file"
            if npx md-to-pdf "$md_file" --config-file pdf-config.json --basedir . --output "pdf_output/$dir_path/$filename.pdf"; then
              echo "âœ“ Success: pdf_output/$dir_path/$filename.pdf"
            else
              echo "âœ— Failed: $md_file"
            fi
          fi
        done
    
    - name: Check PDF generation results
      run: |
        pdf_count=$(find pdf_output -name "*.pdf" 2>/dev/null | wc -l)
        echo "Generated $pdf_count PDF files"
        
        if [ $pdf_count -eq 0 ]; then
          echo "No PDFs were generated. Listing available files..."
          find . -name "*.md" | head -20
          echo "Error: No PDFs generated"
          exit 1
        fi
        
        echo "PDF files generated:"
        find pdf_output -name "*.pdf" | head -10
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        echo "PDF file sizes:"
        find pdf_output -name "*.pdf" -exec sh -c 'echo "  {}: $(stat -c%s "{}" 2>/dev/null || stat -f%z "{}") bytes"' \;
    
    - name: Package PDFs
      run: |
        # ç¡®å®šç‰ˆæœ¬å·
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="latest-$(date +%Y%m%d-%H%M%S)"
        fi
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd pdf_output
        zip -r "../documentation-${VERSION}.zip" .
        cd ..
        
        echo "Created: documentation-${VERSION}.zip"
        
        # è®¡ç®—å¹¶æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        if [ -f "documentation-${VERSION}.zip" ]; then
          file_size=$(stat -c%s "documentation-${VERSION}.zip")
          file_size_mb=$(echo "scale=2; $file_size / 1024 / 1024" | bc)
          echo "Archive size: ${file_size_mb} MB"
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf-documents
        path: |
          pdf_output/
          documentation-*.zip
        retention-days: 30

  create-release:
    needs: convert-md-to-pdf
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download PDF artifacts
      uses: actions/download-artifact@v4
      with:
        name: pdf-documents
        path: ./pdf-artifacts
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Documentation v${{ github.ref_name }}
        body: |
          # ğŸ“„ PDF Documentation Release
          
          This release contains PDF versions of all Markdown documentation.
          
          ## ğŸ“Š Summary
          - **Generated on**: $(date)
          - **Version**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          
          ## ğŸ“¦ Contents
          1. **Complete Archive** (`documentation-${{ github.ref_name }}.zip`): Contains all PDFs
          2. **Individual PDFs**: Available in the pdf_output/ directory
          
          ## ğŸ”§ How to Use
          1. Download the ZIP archive for offline use
          2. Extract to view individual PDF files
          3. Open PDFs in any PDF viewer
          
          ## ğŸ“ File Structure
          The PDFs maintain the same directory structure as the original Markdown files.
          
          ---
          
          *Generated automatically by GitHub Actions*
        draft: false
        prerelease: false
        files: |
          pdf-artifacts/documentation-${{ github.ref_name }}.zip
          pdf-artifacts/pdf_output/**/*.pdf
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}