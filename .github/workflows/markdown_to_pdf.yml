name: "Convert Markdown to PDF with mark2pdf"

on:
  push:
    branches: ["main", "master"]
    tags: ["v*", "pdf-*"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18' # mark2pdf 要求 Node.js >= 16.15.0
          cache: 'pnpm' # 如果使用 pnpm

      - name: "Install mark2pdf globally"
        run: |
          # 方案A：直接从GitHub仓库安装（假设仓库可公开访问）
          npm install -g https://github.com/evanfang0054/mark2pdf
          # 方案B：如果方案A失败，则克隆、构建并本地安装
          # git clone https://github.com/evanfang0054/mark2pdf.git
          # cd mark2pdf
          # pnpm install && pnpm run build
          # npm link # 或使用 pnpm 的全局安装方式
          mark2pdf --version # 验证安装

      - name: "创建 mark2pdf 配置文件"
        run: |
          cat > config.json << 'EOF'
          {
            "input": {
              "path": ".",
              "extensions": [".md"],
              "filters": {
                "exclude": [".git", "node_modules", "pdf_output"]
              }
            },
            "output": {
              "path": "./pdf_output",
              "createDirIfNotExist": true,
              "maintainDirStructure": true
            },
            "options": {
              "concurrent": 3,
              "timeout": 60000,
              "format": "A4",
              "orientation": "portrait"
            },
            "features": {
              "incremental": false
            }
          }
          EOF
          
          # 创建基础CSS样式文件，尝试优化代码块换行
          mkdir -p assets
          cat > assets/pdf-style.css << 'EOF'
          body {
            font-family: 'Noto Serif CJK SC', 'Source Han Serif SC', SimSun, serif;
            line-height: 1.6;
            font-size: 11pt;
          }
          pre, code {
            font-family: 'Noto Sans Mono CJK SC', 'Courier New', monospace;
            background-color: #f8f8f8;
            border-radius: 3px;
          }
          pre {
            padding: 1em;
            overflow-wrap: break-word;
            white-space: pre-wrap; /* 关键：允许代码换行 */
          }
          img {
            max-width: 100%;
            height: auto;
          }
          table {
            border-collapse: collapse;
            width: 100%;
          }
          th, td {
            border: 1px solid #ddd;
            padding: 8px;
          }
          blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1em;
            color: #555;
          }
          EOF

      - name: "（可选）预处理Markdown文件"
        run: |
          # 这里可以放置您之前的部分Python预处理逻辑
          # 例如：修复特定的字符问题（0@100 -> 0~100）、移除图片标签行等
          # 由于 mark2pdf 使用不同的渲染引擎，部分预处理可能不再需要或需要调整
          echo "根据需要进行Markdown预处理"

      - name: "运行 mark2pdf 进行转换"
        run: |
          mark2pdf convert -c config.json --verbose
        env:
          # 如果工具需要特定环境变量可以在这里设置
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: "（可选）后处理：添加简单水印"
        run: |
          # 警告：这是单页、非平铺的简单水印示例，与您之前的效果不同。
          # 您需要安装额外的工具，例如 pdftk 或 qpdf。
          # 由于效果差异大，此步骤仅供参考，通常不建议添加。
          echo "平铺式水印是LaTeX方案的特色，在PDF后处理中难以完美复现。"
          echo "如需添加简单水印，可考虑使用像 'pdf-stamp' 这样的Node库，但功能有限。"

      - name: "复制资源文件"
        run: |
          # 将原目录中的 resource 文件夹复制到对应的PDF输出目录
          find . -name "*.md" -path "*/node_modules/*" -prune -o -type f -name "*.md" -print | while read md_file; do
            md_dir=$(dirname "$md_file")
            # 计算相对于仓库根目录的路径
            rel_dir=${md_dir#./}
            if [ -d "$md_dir/resource" ]; then
              pdf_output_dir="./pdf_output/$rel_dir"
              mkdir -p "$pdf_output_dir"
              cp -r "$md_dir/resource" "$pdf_output_dir/" 2>/dev/null || echo "注意：复制 $md_dir/resource 可能失败（如已存在）"
            fi
          done

      - name: "验证并打包输出"
        run: |
          if [ -d "./pdf_output" ]; then
            echo "PDF输出目录内容:"
            find ./pdf_output -name "*.pdf" | head -10
            total_pdfs=$(find ./pdf_output -name "*.pdf" | wc -l)
            echo "总共生成 $total_pdfs 个PDF文件。"
            # 打包输出，便于下载
            cd ./pdf_output && zip -r ../pdf-output-archive.zip . && cd ..
          else
            echo "错误：未生成 pdf_output 目录。"
            exit 1
          fi

      - name: "上传生成物"
        uses: actions/upload-artifact@v4
        with:
          name: pdf-documents-mark2pdf
          path: |
            pdf_output/
            pdf-output-archive.zip
          retention-days: 7