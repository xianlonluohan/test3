name: "Convert Markdown to PDF with mark2pdf (pnpm)"

on:
  push:
    branches: ["main", "master"]
    tags: ["v*", "pdf-*"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'  # 启用pnpm缓存

      - name: "Install pnpm"
        run: |
          # Ubuntu环境中，actions/setup-node的cache: 'pnpm'可能不会自动安装pnpm
          # 所以显式安装pnpm
          npm install -g pnpm@8
          pnpm --version

      - name: "安装 mark2pdf"
        run: |
          # 方案A：从GitHub直接安装（如果项目配置了bin）
          echo "尝试从GitHub直接安装mark2pdf..."
          pnpm install -g "https://github.com/evanfang0054/mark2pdf" || {
            echo "直接安装失败，改为克隆后构建安装..."
            # 方案B：克隆、构建、安装
            git clone https://github.com/evanfang0054/mark2pdf.git mark2pdf-tool
            cd mark2pdf-tool
            pnpm install
            pnpm run build
            # 使用npm link创建全局链接（因为pnpm link --global需要特殊权限）
            npm link
            cd ..
          }
          
          # 验证安装
          if command -v mark2pdf &> /dev/null; then
            mark2pdf --version
          else
            # 如果全局命令不可用，尝试直接使用本地构建的版本
            if [ -f "./mark2pdf-tool/dist/bin/mark2pdf.js" ]; then
              echo "mark2pdf全局命令未找到，但找到本地构建版本"
              # 创建软链接到/usr/local/bin以便后续步骤使用
              sudo ln -sf "$(pwd)/mark2pdf-tool/dist/bin/mark2pdf.js" /usr/local/bin/mark2pdf
              mark2pdf --version
            else
              echo "错误：无法找到mark2pdf可执行文件"
              exit 1
            fi
          fi

      - name: "创建配置文件"
        run: |
          # 创建mark2pdf配置文件
          cat > config.json << 'EOF'
          {
            "input": {
              "path": ".",
              "extensions": [".md"],
              "filters": {
                "exclude": ["**/.git/**", "**/node_modules/**", "**/pdf_output/**"]
              }
            },
            "output": {
              "path": "./pdf_output",
              "createDirIfNotExist": true,
              "maintainDirStructure": true
            },
            "options": {
              "concurrent": 3,
              "timeout": 60000,
              "format": "A4",
              "orientation": "portrait"
            }
          }
          EOF
          
          # 创建CSS样式文件
          mkdir -p assets
          cat > assets/pdf-style.css << 'EOF'
          /* 基础样式 */
          body {
            font-family: 'Noto Serif SC', 'Source Han Serif SC', SimSun, serif;
            line-height: 1.6;
            font-size: 11pt;
            margin: 0;
            padding: 20px;
          }
          
          /* 代码块样式 - 重点解决换行问题 */
          pre, code {
            font-family: 'Noto Sans Mono SC', 'Courier New', monospace;
          }
          
          pre {
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 1em;
            overflow-x: auto;
            white-space: pre-wrap; /* 允许代码换行 */
            word-wrap: break-word;
            word-break: break-all;
          }
          
          code {
            background-color: #f5f5f5;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
          }
          
          /* 图片样式 */
          img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em auto;
          }
          
          /* 表格样式 */
          table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
          }
          
          th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
          }
          
          th {
            background-color: #f2f2f2;
          }
          
          /* 引用块样式 */
          blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1em;
            margin-left: 0;
            color: #555;
            font-style: italic;
          }
          
          /* 标题样式 */
          h1, h2, h3, h4, h5, h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: bold;
          }
          
          h1 { font-size: 1.8em; }
          h2 { font-size: 1.5em; }
          h3 { font-size: 1.3em; }
          
          /* 列表样式 */
          ul, ol {
            padding-left: 2em;
          }
          
          li {
            margin-bottom: 0.5em;
          }
          
          /* 水平线 */
          hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2em 0;
          }
          EOF

      - name: "运行转换"
        run: |
          echo "开始转换Markdown文件为PDF..."
          # 使用详细模式运行，便于调试
          mark2pdf convert -c config.json --verbose || {
            echo "转换过程中出现错误，但将继续执行后续步骤..."
            # 检查是否有PDF生成
            if find ./pdf_output -name "*.pdf" 2>/dev/null | head -1; then
              echo "找到已生成的PDF文件"
            fi
          }

      - name: "复制资源文件"
        run: |
          echo "复制resource目录到输出目录..."
          # 查找所有有PDF文件的目录，复制对应的resource目录
          find pdf_output -name "*.pdf" -type f 2>/dev/null | while read pdf_file; do
            pdf_dir=$(dirname "$pdf_file")
            # 从pdf_output目录反向找到源目录
            rel_dir=${pdf_dir#pdf_output/}
            if [ -d "$rel_dir/resource" ]; then
              echo "复制 $rel_dir/resource 到 $pdf_dir/"
              cp -r "$rel_dir/resource" "$pdf_dir/" 2>/dev/null || echo "注意：复制 $rel_dir/resource 可能失败"
            fi
          done

      - name: "验证并打包输出"
        run: |
          if [ -d "./pdf_output" ]; then
            echo "PDF输出目录结构:"
            find ./pdf_output -type f -name "*.pdf" | head -20
            
            total_pdfs=$(find ./pdf_output -type f -name "*.pdf" 2>/dev/null | wc -l)
            if [ "$total_pdfs" -eq 0 ]; then
              echo "警告：没有生成任何PDF文件"
              # 列出可能的原因
              echo "检查是否有Markdown文件:"
              find . -name "*.md" -not -path "./pdf_output/*" -not -path "./node_modules/*" -not -path "./mark2pdf-tool/*" | head -10
            else
              echo "成功生成 $total_pdfs 个PDF文件"
              # 计算总大小
              total_size=$(find ./pdf_output -name "*.pdf" -exec stat -c%s {} \; 2>/dev/null | awk '{sum+=$1} END {print int(sum/1024)}')
              echo "PDF文件总大小: ${total_size}KB"
            fi
            
            # 打包输出
            cd ./pdf_output
            zip -r ../pdf-output-bundle.zip .
            cd ..
            echo "已创建打包文件: pdf-output-bundle.zip"
          else
            echo "错误：未生成 pdf_output 目录"
            exit 1
          fi

      - name: "上传生成物"
        uses: actions/upload-artifact@v4
        with:
          name: pdf-output-pnpm
          path: |
            pdf_output/
            pdf-output-bundle.zip
          retention-days: 7