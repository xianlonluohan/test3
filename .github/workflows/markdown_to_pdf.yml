name: Convert Markdown to PDF and Release

on:
  push:
    tags:
      - 'v*'  # 当创建以v开头的tag时触发
    branches:
      - main
      - develop
  workflow_dispatch:  # 允许手动触发

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    
    outputs:
      pdf_files: ${{ steps.find-pdfs.outputs.pdf_files }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史记录，确保能获取tag信息
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        # 安装markdown-pdf和其他可能需要的前端工具
        npm install -g markdown-pdf
        npm install -g mermaid.cli
        
        # 安装Pandoc作为备选方案
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra
        
        # 安装中文字体（如果需要中文支持）
        sudo apt-get install -y fonts-noto-cjk
    
    - name: Find all Markdown files
      id: find-md-files
      run: |
        # 查找所有目录中的markdown文件
        find . -name "*.md" ! -path "./.git/*" ! -path "./node_modules/*" > markdown_files.txt
        echo "Found markdown files:"
        cat markdown_files.txt
        echo "md_files=$(cat markdown_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
    
    - name: Create output directory
      run: |
        mkdir -p pdf_output
    
    - name: Convert Markdown to PDF (使用markdown-pdf)
      run: |
        # 读取所有markdown文件
        while IFS= read -r md_file; do
          if [ -f "$md_file" ]; then
            echo "Processing: $md_file"
            
            # 获取相对路径并创建对应的PDF路径
            pdf_path="pdf_output/$(dirname "$md_file")"
            mkdir -p "$pdf_path"
            
            # 获取不带扩展名的文件名
            filename=$(basename "$md_file" .md)
            
            # 使用markdown-pdf转换
            if markdown-pdf "$md_file" -o "pdf_output/${filename}.pdf" --paper-format "A4" --paper-orientation "portrait"; then
              echo "Successfully converted: $md_file"
            else
              echo "markdown-pdf failed for $md_file, trying pandoc..."
              # 如果markdown-pdf失败，尝试使用pandoc
              pandoc "$md_file" \
                --pdf-engine=xelatex \
                -V geometry:margin=1in \
                -V mainfont="Noto Serif CJK SC" \
                -V lang=zh-CN \
                -o "pdf_output/${filename}.pdf"
            fi
          fi
        done < markdown_files.txt
    
    - name: Convert with custom CSS (可选)
      run: |
        # 如果有自定义CSS，可以使用
        if [ -f "pdf.css" ]; then
          echo "Using custom CSS for conversion"
          while IFS= read -r md_file; do
            if [ -f "$md_file" ]; then
              filename=$(basename "$md_file" .md)
              markdown-pdf "$md_file" -o "pdf_output/${filename}-styled.pdf" -s pdf.css
            fi
          done < markdown_files.txt
        fi
    
    - name: Handle images and resources
      run: |
        # 复制图片和资源文件夹到PDF输出目录，保持相对路径
        find . -type d \( -name "picture" -o -name "pictures" -o -name "image" -o -name "images" -o -name "resource" -o -name "resources" \) \
          ! -path "./.git/*" ! -path "./pdf_output/*" | while read -r dir; do
          # 计算相对路径
          rel_path=${dir#./}
          target_dir="pdf_output/$rel_path"
          mkdir -p "$target_dir"
          cp -r "$dir"/* "$target_dir/" 2>/dev/null || true
        done
        
        # 复制所有图片文件（保持目录结构）
        find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \
          ! -path "./.git/*" ! -path "./pdf_output/*" | while read -r img; do
          rel_path=${img#./}
          target_dir="pdf_output/$(dirname "$rel_path")"
          mkdir -p "$target_dir"
          cp "$img" "$target_dir/"
        done
    
    - name: Create PDF index
      run: |
        # 创建PDF文件的索引README
        echo "# PDF Documentation Index" > pdf_output/README.md
        echo "Generated on: $(date)" >> pdf_output/README.md
        echo "" >> pdf_output/README.md
        echo "## Available PDF Files" >> pdf_output/README.md
        echo "" >> pdf_output/README.md
        
        find pdf_output -name "*.pdf" | sort | while read -r pdf; do
          rel_path=${pdf#pdf_output/}
          echo "- [${rel_path}](${rel_path})" >> pdf_output/README.md
        done
        
        # 如果存在图片资源
        if [ -n "$(find pdf_output -type d -name '*picture*' -o -name '*image*' -o -name '*resource*')" ]; then
          echo "" >> pdf_output/README.md
          echo "## Included Resources" >> pdf_output/README.md
          echo "" >> pdf_output/README.md
          find pdf_output -type d \( -name "*picture*" -o -name "*image*" -o -name "*resource*" \) | while read -r dir; do
            rel_dir=${dir#pdf_output/}
            echo "- ${rel_dir}/" >> pdf_output/README.md
          done
        fi
    
    - name: Package PDFs
      run: |
        # 创建带版本号的压缩包
        VERSION=${GITHUB_REF#refs/tags/}
        if [ "$VERSION" = "$GITHUB_REF" ]; then
          VERSION="latest-$(date +%Y%m%d-%H%M%S)"
        fi
        
        cd pdf_output
        zip -r "../documentation-${VERSION}.zip" .
        cd ..
        
        echo "PDF_FILES=documentation-${VERSION}.zip" >> $GITHUB_ENV
    
    - name: Find generated PDFs
      id: find-pdfs
      run: |
        # 列出所有生成的PDF文件
        find pdf_output -name "*.pdf" > pdf_list.txt
        echo "Generated PDFs:"
        cat pdf_list.txt
        
        # 将PDF列表输出到下一步骤
        pdf_files_json=$(jq -R -n -c '[inputs]' < pdf_list.txt || echo '[]')
        echo "pdf_files=$pdf_files_json" >> $GITHUB_OUTPUT

  create-release:
    needs: convert-md-to-pdf
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download PDF artifacts
      uses: actions/download-artifact@v4
      with:
        name: pdf-documents
        path: ./pdf-artifacts
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: Documentation v${{ github.ref_name }}
        body: |
          # Documentation PDFs
          
          This release contains PDF versions of all Markdown documentation.
          
          ## Contents
          - PDF versions of all documentation
          - Associated images and resources
          - Complete archive for offline use
          
          Generated on: ${{ github.event.head_commit.timestamp }}
          
          ## How to Use
          1. Download the documentation archive
          2. Extract to view PDFs
          3. Open PDF files in any PDF viewer
        draft: false
        prerelease: false
        files: |
          documentation-${{ github.ref_name }}.zip
          pdf-artifacts/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload Release Assets
      if: steps.create_release.outputs.upload_url
      run: |
        # 上传单独的PDF文件到Release
        for pdf_file in $(find pdf-artifacts -name "*.pdf"); do
          echo "Uploading: $pdf_file"
          filename=$(basename "$pdf_file")
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/pdf" \
            -H "Accept: application/vnd.github.v3+json" \
            --data-binary @"$pdf_file" \
            "${{ steps.create_release.outputs.upload_url }}?name=$filename"
        done

  upload-artifacts:
    needs: convert-md-to-pdf
    runs-on: ubuntu-latest
    if: always()  # 即使前面的步骤失败也上传
    
    steps:
    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf-documents
        path: |
          pdf_output/
          documentation-*.zip
        retention-days: 30