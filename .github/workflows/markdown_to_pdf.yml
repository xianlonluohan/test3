name: Markdown to PDF Converter

on:
  push:
    branches: ["main", "master"]
    tags: ["v*"]
  pull_request:
    branches: ["main", "master"]

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    env:
      DOCS_DIR: "docs"  # 修改为你的文档文件夹名称
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install markdown-pdf and dependencies
        run: |
          npm install -g markdown-pdf
          npm install -g puppeteer
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-wqy-zenhei
          
      - name: Find all Markdown files
        id: find-md
        run: |
          # 查找指定目录下的所有.md文件（排除node_modules等目录）
          find "${{ env.DOCS_DIR }}" -name "*.md" -type f | grep -v node_modules > md_files.txt
          
          # 统计文件数量
          FILE_COUNT=$(wc -l < md_files.txt)
          echo "Found $FILE_COUNT markdown files"
          
          # 创建输出目录
          mkdir -p pdf_output
          
          # 将文件列表保存为变量供后续步骤使用
          echo "files=$(cat md_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
          
      - name: Convert Markdown to PDF
        run: |
          # 读取文件列表并逐个转换
          while IFS= read -r md_file; do
            if [ -f "$md_file" ]; then
              echo "Converting: $md_file"
              
              # 获取文件所在目录，用于处理相对路径的图片
              file_dir=$(dirname "$md_file")
              
              # 生成PDF文件名（保持相同结构但扩展名为.pdf）
              pdf_file="pdf_output/$(echo "$md_file" | sed 's/\.md$/.pdf/')"
              
              # 创建PDF文件的目录结构
              mkdir -p "$(dirname "$pdf_file")"
              
              # 转换为PDF，设置中文支持和其他选项
              markdown-pdf "$md_file" \
                --paper-format "A4" \
                --paper-border "1cm" \
                --css-path "github-markdown.css" \
                --remarkable-options '{"html": true}' \
                --out "$pdf_file"
                
              echo "Created: $pdf_file"
            fi
          done < md_files.txt
          
      - name: Create stylesheet for better PDF rendering
        run: |
          # 创建自定义CSS样式以改进PDF渲染
          cat > github-markdown.css << 'EOF'
          /* 基础样式 */
          body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, "Noto Sans CJK SC", "WenQuanYi Micro Hei", sans-serif;
            font-size: 12pt;
            line-height: 1.6;
            color: #333;
            background-color: #fff;
            padding: 20px;
            margin: 0;
          }
          
          /* 标题样式 */
          h1, h2, h3, h4, h5, h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
          }
          
          h1 { font-size: 1.8em; border-bottom: 2px solid #eaecef; padding-bottom: 0.3em; }
          h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
          h3 { font-size: 1.3em; }
          h4 { font-size: 1.1em; }
          
          /* 代码块样式 */
          pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 11pt;
          }
          
          code {
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            padding: 0.2em 0.4em;
            font-size: 11pt;
          }
          
          /* 图片样式 */
          img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em auto;
          }
          
          /* 表格样式 */
          table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
          }
          
          th, td {
            border: 1px solid #dfe2e5;
            padding: 8px 12px;
            text-align: left;
          }
          
          th {
            background-color: #f6f8fa;
            font-weight: 600;
          }
          
          /* 列表样式 */
          ul, ol {
            padding-left: 2em;
          }
          
          li {
            margin: 0.5em 0;
          }
          
          /* 链接样式 */
          a {
            color: #0366d6;
            text-decoration: none;
          }
          
          a:hover {
            text-decoration: underline;
          }
          
          /* 引用块样式 */
          blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            margin: 1em 0;
            padding-left: 1em;
          }
          
          /* 页眉页脚 */
          @page {
            margin: 2cm;
            @top-center {
              content: "";
            }
            @bottom-right {
              content: "第 " counter(page) " 页，共 " counter(pages) " 页";
              font-size: 10pt;
              color: #666;
            }
          }
          
          /* 打印优化 */
          @media print {
            body {
              padding: 0;
            }
            
            pre, code {
              page-break-inside: avoid;
            }
            
            h1, h2, h3, h4, h5, h6 {
              page-break-after: avoid;
            }
            
            img {
              page-break-inside: avoid;
              page-break-after: avoid;
            }
            
            table {
              page-break-inside: avoid;
            }
          }
          EOF
          
      - name: Create consolidated PDF package
        run: |
          # 创建包含所有PDF的zip文件
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ZIP_NAME="documentation_${TIMESTAMP}.zip"
          
          # 进入pdf_output目录并压缩所有内容
          cd pdf_output
          zip -r "../${ZIP_NAME}" .
          cd ..
          
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
          
      - name: Upload PDF package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-pdfs
          path: |
            ${{ env.ZIP_NAME }}
            pdf_output/
          retention-days: 7
          
  release:
    needs: convert-md-to-pdf
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Download PDF artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation-pdfs
          
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            # 文档发布
            
            此版本包含以下文档的PDF版本：
            
            - 所有Markdown文档已转换为PDF格式
            - 包含原始目录结构
            - 优化中文显示支持
            
            生成时间: ${{ steps.date.outputs.date }}
            
            要下载所有PDF文档，请下载下方的ZIP文件。
          draft: false
          prerelease: false
          files: |
            *.zip
            pdf_output/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT