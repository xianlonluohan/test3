name: Markdown to PDF Converter

on:
  push:
    tags:
      - 'v*'  # 仅当创建v开头的tag时触发
      - '*.*.*'  # 或者任何语义化版本tag

jobs:
  convert-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有历史以便生成changelog
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install markdown-pdf and dependencies
        run: |
          npm install -g markdown-pdf
          npm install -g @iktakahiro/markdown-pdf  # 备用工具
          # 安装额外的依赖（如果需要处理图片）
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-extra
      
      - name: Find all markdown files
        id: find-md
        run: |
          # 查找所有.md文件，排除node_modules等目录
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" > md-files.txt
          echo "Found $(wc -l < md-files.txt) markdown files"
          
          # 创建输出目录
          mkdir -p pdf-output
      
      - name: Convert markdown to PDF
        run: |
          while IFS= read -r md_file; do
            echo "Converting: $md_file"
            
            # 获取相对路径并创建对应的PDF输出路径
            relative_path="${md_file#./}"
            pdf_path="pdf-output/${relative_path%.md}.pdf"
            
            # 创建PDF文件的目录结构
            mkdir -p "$(dirname "$pdf_path")"
            
            # 使用markdown-pdf转换
            # 注意：这里可以根据需要调整markdown-pdf的选项
            # --css-path 可以指定自定义CSS样式
            # --paper-format A4 --paper-orientation portrait 设置纸张
            
            # 方案1: 使用markdown-pdf（npm包）
            markdown-pdf \
              --paper-format A4 \
              --paper-orientation portrait \
              --paper-border 2cm \
              --css-path .github/workflows/pdf-styles.css 2>/dev/null \
              "$md_file" \
              "$pdf_path" \
              || echo "markdown-pdf failed for $md_file, trying alternative method..."
            
            # 如果markdown-pdf失败，尝试使用pandoc作为备选方案
            if [ ! -f "$pdf_path" ] || [ ! -s "$pdf_path" ]; then
              echo "Using pandoc as fallback for $md_file"
              pandoc "$md_file" -o "$pdf_path" --pdf-engine=xelatex \
                -V geometry:a4paper \
                -V geometry:margin=2cm \
                -V mainfont="DejaVu Sans" \
                -V monofont="DejaVu Sans Mono"
            fi
            
            # 检查PDF是否生成成功
            if [ -f "$pdf_path" ] && [ -s "$pdf_path" ]; then
              echo "✓ Successfully converted to $pdf_path"
            else
              echo "✗ Failed to convert $md_file"
            fi
            
          done < md-files.txt
      
      - name: Create PDF bundle
        run: |
          # 创建一个包含所有PDF的压缩包
          cd pdf-output
          zip -r "../all-pdfs-$(date +%Y%m%d-%H%M%S).zip" .
          cd ..
          
          # 计算生成的文件数量
          pdf_count=$(find pdf-output -name "*.pdf" | wc -l)
          echo "pdf_count=$pdf_count" >> $GITHUB_ENV
          
          # 将最新生成的zip文件设为输出
          echo "pdf_zip=$(ls -t all-pdfs-*.zip | head -1)" >> $GITHUB_ENV
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Documentation v${{ github.ref_name }}
          body: |
            # Documentation PDFs
            
            This release contains PDF versions of all markdown documentation.
            
            **Generated on:** ${{ fromJSON(format('["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]'))[fromJSON('{0,1,2,3,4,5,6,7,8,9,10,11}')] }} ${{ fromJSON(format('["0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"]'))[fromJSON('{0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31}')] }}, ${{ fromJSON('2024') }}
            
            **Contents:**
            - ${{ env.pdf_count }} PDF files bundled in `${{ env.pdf_zip }}`
            - Individual PDF files for each markdown document
            
            **Tag:** ${{ github.ref_name }}
            
            **Commit:** ${{ github.sha }}
          
          draft: false
          prerelease: false
          files: |
            ${{ env.pdf_zip }}
            pdf-output/**/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload PDFs as artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-pdfs
          path: |
            pdf-output/
            ${{ env.pdf_zip }}
          retention-days: 7